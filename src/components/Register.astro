<div>
    <h1>Créer un compte</h1>

    <form id="register-form">
        <div>
            <label for="email">Email</label>
            <input
                    id="email"
                    type="email"
                    name="email"
                    placeholder="votre@email.com"
                    required
            />
        </div>

        <div>
            <label for="password">Mot de passe</label>
            <input
                    id="password"
                    type="password"
                    name="password"
                    placeholder="••••••••"
                    required
                    minlength="3"
            />
            <p>Au moins 3 caractères</p>
        </div>

        <button type="submit">
            Créer un compte
        </button>
    </form>

    <p>
        Déjà un compte ?
        <a href="/signin">Se connecter</a>
    </p>

    <div id="register-message" style="display: none;"></div>
</div>

<script>
    import { supabase } from "@/db/supabase";

    const form = document.querySelector("#register-form") as HTMLFormElement | null;
    const messageDiv = document.querySelector("#register-message") as HTMLDivElement | null;

    if (form && messageDiv) {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const formData = new FormData(form);
            const email = formData.get("email")?.toString() || "";
            const password = formData.get("password")?.toString() || "";

            const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement | null;

            if (!submitButton) return;

            submitButton.disabled = true;
            submitButton.textContent = "Création en cours...";

            try {
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password,
                });

                if (error) {
                    messageDiv.style.display = "block";
                    messageDiv.style.color = "red";
                    messageDiv.textContent = error.message || "Une erreur est survenue";

                    submitButton.disabled = false;
                    submitButton.textContent = "Créer un compte";
                    return;
                }

                messageDiv.style.display = "block";
                messageDiv.style.color = "green";
                messageDiv.textContent = "Compte créé avec succès ! Redirection...";

                console.log("Utilisateur créé:", data);

                setTimeout(() => {
                    window.location.href = "/";
                }, 2000);

            } catch (error) {
                console.error("Erreur:", error);
                messageDiv.style.display = "block";
                messageDiv.style.color = "red";
                messageDiv.textContent = "Erreur de connexion";

                submitButton.disabled = false;
                submitButton.textContent = "Créer un compte";
            }
        });
    }
</script>
