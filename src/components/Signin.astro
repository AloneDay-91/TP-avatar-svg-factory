<div>
    <h1>Se connecter</h1>

    <form id="signin-form">
        <div>
            <label for="email">Email</label>
            <input
                    id="email"
                    type="email"
                    name="email"
                    placeholder="votre@email.com"
                    required
            />
        </div>

        <div>
            <label for="password">Mot de passe</label>
            <input
                    id="password"
                    type="password"
                    name="password"
                    placeholder="••••••••"
                    required
            />
        </div>

        <button type="submit">
            Se connecter
        </button>
    </form>

    <p>
        Pas encore de compte ?
        <a href="/register">Créer un compte</a>
    </p>

    <div id="signin-message" style="display: none;"></div>
</div>

<script>
    import { supabase } from "@/db/supabase";

    const form = document.querySelector("#signin-form") as HTMLFormElement | null;
    const messageDiv = document.querySelector("#signin-message") as HTMLDivElement | null;

    if (form && messageDiv) {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const formData = new FormData(form);
            const email = formData.get("email")?.toString() || "";
            const password = formData.get("password")?.toString() || "";

            const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement | null;

            if (!submitButton) return;

            submitButton.disabled = true;
            submitButton.textContent = "Connexion en cours...";

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password,
                });

                if (error) {
                    messageDiv.style.display = "block";
                    messageDiv.style.color = "red";
                    messageDiv.textContent = error.message || "Identifiants incorrects";

                    submitButton.disabled = false;
                    submitButton.textContent = "Se connecter";
                    return;
                }

                messageDiv.style.display = "block";
                messageDiv.style.color = "green";
                messageDiv.textContent = "Connexion réussie ! Redirection...";

                console.log("Utilisateur connecté:", data);

                setTimeout(() => {
                    window.location.href = "/";
                }, 1000);

            } catch (error) {
                console.error("Erreur:", error);
                messageDiv.style.display = "block";
                messageDiv.style.color = "red";
                messageDiv.textContent = "Erreur de connexion";

                submitButton.disabled = false;
                submitButton.textContent = "Se connecter";
            }
        });
    }
</script>
