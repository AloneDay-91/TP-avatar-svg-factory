---
import AvatarGenerator from '../components/AvatarGenerator';
import '../styles/global.css';
import { Button } from "@/components/ui/button";
---

<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<meta name="description" content="Generate unique SVG avatars powered by Gemini AI" />
		<title>Avatar Generator - AI Powered SVG Avatars</title>
	</head>
	<body>

    <div id="main-content">
        <div class="flex gap-4 mb-4 justify-end items-center p-4">
            <!-- État non connecté -->
            <button id="google-signin-btn" style="display: none;" class="flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-md bg-white hover:bg-gray-50 cursor-pointer">
                <svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
                    <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"/>
                    <path d="M9.003 18c2.43 0 4.467-.806 5.956-2.18l-2.909-2.26c-.806.54-1.836.86-3.047.86-2.344 0-4.328-1.584-5.036-3.711H.96v2.332C2.44 15.983 5.485 18 9.003 18z" fill="#34A853"/>
                    <path d="M3.964 10.712c-.18-.54-.282-1.117-.282-1.71 0-.593.102-1.17.282-1.71V4.96H.957C.347 6.175 0 7.55 0 9.002c0 1.452.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/>
                    <path d="M9.003 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.464.891 11.428 0 9.002 0 5.485 0 2.44 2.017.96 4.958L3.967 7.29c.708-2.127 2.692-3.71 5.036-3.71z" fill="#EA4335"/>
                </svg>
                Se connecter avec Google
            </button>
            <!-- État connecté -->
            <div id="user-info" style="display: none;" class="flex items-center gap-4">
                <span id="user-email" class="text-sm text-gray-600"></span>
                <Button id="logout-btn" variant="outline">Déconnexion</Button>
            </div>
        </div>
		<AvatarGenerator client:only="react" />
    </div>

	</body>
</html>
<script>
    import { supabase } from "@/db/supabase";

    const googleSigninBtn = document.getElementById('google-signin-btn');
    const userInfo = document.getElementById('user-info');
    const userEmail = document.getElementById('user-email');
    const logoutBtn = document.getElementById('logout-btn');

    // Vérifier l'état de connexion au chargement
    async function checkAuth() {
        const { data: { session } } = await supabase.auth.getSession();

        if (session?.user) {
            // Utilisateur connecté
            if (googleSigninBtn) googleSigninBtn.style.display = 'none';
            if (userInfo) userInfo.style.display = 'flex';
            if (userEmail) userEmail.textContent = `Connecté avec Google : ${session.user.email}`;
        } else {
            // Non connecté
            if (googleSigninBtn) googleSigninBtn.style.display = 'flex';
            if (userInfo) userInfo.style.display = 'none';
        }
    }

    // Connexion Google
    if (googleSigninBtn) {
        googleSigninBtn.addEventListener('click', async () => {
            await supabase.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: window.location.origin
                }
            });
        });
    }

    // Déconnexion
    if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.reload();
        });
    }

    // Écouter les changements d'état d'auth (utile après OAuth redirect)
    supabase.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_IN' && session?.user) {
            if (googleSigninBtn) googleSigninBtn.style.display = 'none';
            if (userInfo) userInfo.style.display = 'flex';
            if (userEmail) userEmail.textContent = `Email : ${session.user.email}`;
        }
    });

    // Vérifier au chargement
    checkAuth();
</script>
